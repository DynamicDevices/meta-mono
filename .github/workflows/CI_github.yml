name: meta-mono

on:
  push:
    branches:
      - master
  pull_request:
    paths-ignore:
      - "**.md"
jobs:
  build-and-test:
    runs-on: [self-hosted, linux, X64]
    timeout-minutes: 600
    container:
      image: dynamicdevices/yocto-ci-build:latest
      options: --privileged --platform linux/amd64  -v /dev/net/tun:/dev/net/tun -v /dev/kvm:/dev/kvm
    strategy:
      matrix:
        dotnet_version: [8.0.403, 6.0.427]
        mono_version: [6.12.0.206]
        branch: [styhead]
        arch: [x86-64, arm64]
    env:
      name: build-and-test
      MONO_VERSION: ${{ matrix.mono_version }}
      DOTNET_VERSION: ${{ matrix.dotnet_version }}
      ARCH: ${{ matrix.arch }}
      BRANCH: ${{ matrix.branch }}
    steps:
    - name: Building Mono Test Image
      run: |
        kas build kas/ci.yml
        bitbake test-image-mono
#    - name: CVE Check Mono / dotNet
#      run: |
#        . ./${BRANCH}/poky/oe-init-build-env ${BRANCH}/build
#        export TERM=linux
#        bitbake mono -c cve_check
#        mv $GITHUB_WORKSPACE/${BRANCH}/build/tmp/log/cve/cve-summary.json $GITHUB_WORKSPACE/${BRANCH}/build/tmp/log/cve/cve-summary-mono.json
#        bitbake dotnet -c cve_check
#        mv $GITHUB_WORKSPACE/${BRANCH}/build/tmp/log/cve/cve-summary.json $GITHUB_WORKSPACE/${BRANCH}/build/tmp/log/cve/cve-summary-dotnet.json
#    - name: Testing
#      run: |
#        . ./${BRANCH}/poky/oe-init-build-env ${BRANCH}/build
#        export TERM=linux
#        bitbake test-image-mono -c testimage
    - name: Store artifacts
      uses: actions/upload-artifact@v4
      with:
        name: test-image-mono-${{ matrix.branch }}-${{ matrix.mono_version }}-${{ matrix.dotnet_version }}-${{ github.sha }}-${{ matrix.arch }}
        path: ./${{ matrix.branch }}/build/tmp/deploy/images/qemu${{ matrix.arch }}/
    - name: Store CVEs
      uses: actions/upload-artifact@v4
      with:
        name: cve-summary-${{ matrix.branch }}-${{ matrix.mono_version }}-${{ matrix.dotnet_version }}-${{ github.sha }}-${{ matrix.arch }}
        path: ./${{ matrix.branch }}/build/tmp/log/cve/*.json
